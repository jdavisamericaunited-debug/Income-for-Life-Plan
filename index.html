<script>
  // ---------- Shared helpers ----------
  function apParseCurrency(val) {
    if (!val) return 0;
    if (typeof val !== 'string') val = String(val);
    val = val.replace(/[^0-9.\-]/g, '');
    if (!val) return 0;
    var num = parseFloat(val);
    return isNaN(num) ? 0 : num;
  }

  function apFormatCurrency(num) {
    return '$' + (num || 0).toLocaleString(undefined, {
      minimumFractionDigits: 0,
      maximumFractionDigits: 2
    });
  }

  function apGetInputValue(nameOrId) {
    var el = document.querySelector('[name="' + nameOrId + '"]') ||
             document.getElementById(nameOrId);
    return el ? el.value || '' : '';
  }

  function apSetInputValue(idOrName, val) {
    var byId = document.getElementById(idOrName);
    if (byId) {
      byId.value = val;
      return;
    }
    var byName = document.querySelector('[name="' + idOrName + '"]');
    if (byName) byName.value = val;
  }

  // ---------- Save / load Goals & Data to localStorage ----------
  function apSaveGoalsDataToStorage() {
    if (!window.localStorage) return;
    var form = document.getElementById('ap-goals-data-form');
    if (!form) return;
    var data = {};
    Array.prototype.forEach.call(form.elements, function(el) {
      if (!el.name) return;
      if (['button','submit','reset'].indexOf(el.type) !== -1) return;
      data[el.name] = el.value;
    });
    localStorage.setItem('apGoalsDataForm', JSON.stringify(data));
  }

  function apLoadGoalsDataFromStorage() {
    if (!window.localStorage) return;
    var raw = localStorage.getItem('apGoalsDataForm');
    if (!raw) return;
    var form = document.getElementById('ap-goals-data-form');
    if (!form) return;
    var data;
    try { data = JSON.parse(raw); } catch(e) { return; }
    Object.keys(data).forEach(function(name) {
      var el = form.elements[name];
      if (!el) return;
      el.value = data[name];
    });
  }

  // ---------- Data Form totals (mirror Excel logic) ----------
  function apUpdateDataFormTotals() {
    // INVESTMENTS: TOTALS row like =SUM(D47:D56)
    var invTotal = 0;
    for (var j = 1; j <= 10; j++) { // up to 10 lines if you expand later
      var rawInv = apGetInputValue('inv' + j + 'Balance');
      invTotal += apParseCurrency(rawInv);
    }
    var invTotalField = document.querySelector('[name="invTotalBalance"]');
    if (invTotalField) {
      invTotalField.value = apFormatCurrency(invTotal);
    }

    // SAVINGS: Total like =SUM(C59:C68)
    var savTotal = 0;
    for (var i = 1; i <= 10; i++) { // room to grow
      var rawSav = apGetInputValue('save' + i + 'Balance');
      savTotal += apParseCurrency(rawSav);
    }
    var savTotalField = document.querySelector('[name="saveTotalBalance"]');
    if (savTotalField) {
      savTotalField.value = apFormatCurrency(savTotal);
    }

    // ANNUITIES: Total like =C71+C72+C73+C74+C75
    var annTotal = 0;
    for (var k = 1; k <= 10; k++) { // room to grow
      var rawAnn = apGetInputValue('ann' + k + 'Balance');
      annTotal += apParseCurrency(rawAnn);
    }
    var annTotalField = document.querySelector('[name="annTotalBalance"]');
    if (annTotalField) {
      annTotalField.value = apFormatCurrency(annTotal);
    }

    // INCOME: Approx Total Annual Income like =SUM(D79:D86)
    var incTotal = 0;
    for (var r = 1; r <= 10; r++) {
      var rawInc = apGetInputValue('inc' + r + 'Amount');
      incTotal += apParseCurrency(rawInc);
    }
    var incTotalField = document.querySelector('[name="incTotalAmount"]');
    if (incTotalField) {
      incTotalField.value = apFormatCurrency(incTotal);
    }
  }

  // ---------- Asset Summary updater ----------
  function apUpdateAssetSummary() {
    // Keep Data Form totals in sync whenever we refresh the summary
    apUpdateDataFormTotals();

    var now = new Date();
    var dateSpan = document.getElementById('ap-asset-summary-date');
    if (dateSpan) {
      var dateStr = now.toLocaleDateString() + ' ' +
        now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      dateSpan.textContent = dateStr;
    }

    // Name & address
    var nameAddressDiv = document.getElementById('ap-asset-summary-name-address');
    if (nameAddressDiv) {
      var clientName = apGetInputValue('clientName');
      var spouseName = apGetInputValue('spouseName');
      var homeAddress = apGetInputValue('homeAddress');
      var homeCity = apGetInputValue('homeCity');
      var homeState = apGetInputValue('homeState');
      var homeZip = apGetInputValue('homeZip');

      var fullName = (clientName || '') +
        (spouseName ? (clientName ? ' and ' : '') + spouseName : '');
      var addressLine = [homeAddress, homeCity, homeState, homeZip]
        .filter(Boolean)
        .join(' ');

      nameAddressDiv.innerHTML =
        (fullName ? '<div>' + fullName + '</div>' : '') +
        (addressLine ? '<div>' + addressLine + '</div>' : '');
    }

    // ----- CASH (Savings & Credit Union Accounts) -----
    var cashRowsBody = document.getElementById('ap-cash-rows');
    var totalCash = 0;
    if (cashRowsBody) {
      cashRowsBody.innerHTML = '';
      var maxCash = 10; // save1..save10 if needed
      var cashRowCount = 0;

      for (var i = 1; i <= maxCash; i++) {
        var desc = apGetInputValue('save' + i + 'Desc');
        var owner = apGetInputValue('save' + i + 'Owner');
        var balStr = apGetInputValue('save' + i + 'Balance');
        var bal = apParseCurrency(balStr);
        if (!desc && !owner && !balStr) continue;

        cashRowCount++;
        totalCash += bal;

        var tr = document.createElement('tr');
        tr.innerHTML =
          '<td>' + (owner || '') + '</td>' +
          '<td>' + (desc || '') + '</td>' +
          '<td class="ap-num">' + apFormatCurrency(bal) + '</td>';
        cashRowsBody.appendChild(tr);
      }

      // Fallback: if user only cares about the TOTAL field, still show something
      if (cashRowCount === 0) {
        totalCash = apParseCurrency(apGetInputValue('saveTotalBalance'));
        var trAgg = document.createElement('tr');
        trAgg.innerHTML =
          '<td></td>' +
          '<td>Aggregate cash</td>' +
          '<td class="ap-num">' + apFormatCurrency(totalCash) + '</td>';
        cashRowsBody.appendChild(trAgg);
      }

      apSetInputValue('saveTotalBalance', apFormatCurrency(totalCash));
      var elTC = document.getElementById('ap-total-cash');
      if (elTC) elTC.textContent = apFormatCurrency(totalCash);
    }

    // ----- INVESTMENTS -----
    var invRowsBody = document.getElementById('ap-investment-rows');
    var totalInv = 0;
    if (invRowsBody) {
      invRowsBody.innerHTML = '';
      var maxInv = 10; // inv1..inv10
      var invRowCount = 0;

      for (var j = 1; j <= maxInv; j++) {
        var name = apGetInputValue('inv' + j + 'Name');
        var ownerInv = apGetInputValue('inv' + j + 'Owner');
        var typeInv = apGetInputValue('inv' + j + 'Type');
        var balInvStr = apGetInputValue('inv' + j + 'Balance');
        var balInv = apParseCurrency(balInvStr);
        if (!name && !ownerInv && !balInvStr) continue;

        invRowCount++;
        totalInv += balInv;

        var tr2 = document.createElement('tr');
        tr2.innerHTML =
          '<td>' + (ownerInv || '') + '</td>' +
          '<td>' + (name || '') + '</td>' +
          '<td>' + (typeInv || '') + '</td>' +
          '<td class="ap-num">' + apFormatCurrency(balInv) + '</td>';
        invRowsBody.appendChild(tr2);
      }

      if (invRowCount === 0) {
        totalInv = apParseCurrency(apGetInputValue('invTotalBalance'));
        var trAggInv = document.createElement('tr');
        trAggInv.innerHTML =
          '<td></td>' +
          '<td>Aggregate investments</td>' +
          '<td></td>' +
          '<td class="ap-num">' + apFormatCurrency(totalInv) + '</td>';
        invRowsBody.appendChild(trAggInv);
      }

      apSetInputValue('invTotalBalance', apFormatCurrency(totalInv));
      var elTI = document.getElementById('ap-total-investments');
      if (elTI) elTI.textContent = apFormatCurrency(totalInv);
    }

    // ----- PROPERTY & MORTGAGES -----
    var primaryVal = apParseCurrency(apGetInputValue('primaryValue'));
    var primaryMort = apParseCurrency(apGetInputValue('primaryMortgage'));
    var secondaryVal = apParseCurrency(apGetInputValue('secondaryValue'));
    var secondaryMort = apParseCurrency(apGetInputValue('secondaryMortgage'));

    var totalRealEstate = primaryVal + secondaryVal;
    var totalMortgage = primaryMort + secondaryMort;

    var elPrimVal = document.getElementById('ap-primary-value');
    var elPrimMort = document.getElementById('ap-primary-mortgage');
    var elSecVal = document.getElementById('ap-secondary-value');
    var elSecMort = document.getElementById('ap-secondary-mortgage');
    var elTotalRE = document.getElementById('ap-total-real-estate');
    var elTotalMort = document.getElementById('ap-total-mortgage');

    if (elPrimVal) elPrimVal.textContent = apFormatCurrency(primaryVal);
    if (elPrimMort) elPrimMort.textContent = apFormatCurrency(primaryMort);
    if (elSecVal) elSecVal.textContent = apFormatCurrency(secondaryVal);
    if (elSecMort) elSecMort.textContent = apFormatCurrency(secondaryMort);
    if (elTotalRE) elTotalRE.textContent = apFormatCurrency(totalRealEstate);
    if (elTotalMort) elTotalMort.textContent = apFormatCurrency(totalMortgage);

    // ----- ANNUITIES -----
    var annRowsBody = document.getElementById('ap-annuity-rows');
    var totalAnn = 0;
    if (annRowsBody) {
      annRowsBody.innerHTML = '';
      var maxAnn = 10; // ann1..ann10
      var annRowCount = 0;

      for (var k = 1; k <= maxAnn; k++) {
        var annName = apGetInputValue('ann' + k + 'Name');
        var annOwner = apGetInputValue('ann' + k + 'Owner');
        var annType = apGetInputValue('ann' + k + 'Type');
        var annBalStr = apGetInputValue('ann' + k + 'Balance');
        var annBal = apParseCurrency(annBalStr);
        if (!annName && !annOwner && !annBalStr) continue;

        annRowCount++;
        totalAnn += annBal;
        var tr3 = document.createElement('tr');
        tr3.innerHTML =
          '<td>' + (annOwner || '') + '</td>' +
          '<td>' + (annName || '') + '</td>' +
          '<td>' + (annType || '') + '</td>' +
          '<td class="ap-num">' + apFormatCurrency(annBal) + '</td>';
        annRowsBody.appendChild(tr3);
      }

      if (annRowCount === 0) {
        totalAnn = apParseCurrency(apGetInputValue('annTotalBalance'));
        var trAggAnn = document.createElement('tr');
        trAggAnn.innerHTML =
          '<td></td>' +
          '<td>Aggregate annuities</td>' +
          '<td></td>' +
          '<td class="ap-num">' + apFormatCurrency(totalAnn) + '</td>';
        annRowsBody.appendChild(trAggAnn);
      }

      apSetInputValue('annTotalBalance', apFormatCurrency(totalAnn));
      var elTA = document.getElementById('ap-total-annuities');
      if (elTA) elTA.textContent = apFormatCurrency(totalAnn);
    }

    // ----- ROLL-UP TOTALS -----
    var totalAssets = totalCash + totalInv + totalRealEstate + totalAnn;
    var totalLiab = totalMortgage;
    var netWorth = totalAssets - totalLiab;

    var elTotA = document.getElementById('ap-total-assets');
    var elTotL = document.getElementById('ap-total-liabilities');
    var elNW = document.getElementById('ap-net-worth');

    if (elTotA) elTotA.textContent = apFormatCurrency(totalAssets);
    if (elTotL) elTotL.textContent = apFormatCurrency(totalLiab);
    if (elNW) elNW.textContent = apFormatCurrency(netWorth);
  }

  // ---------- Inputs Page auto-calcs ----------
  function apUpdateInputsDerived() {
    // Auto-fill today's date on Inputs tab
    var todayEl = document.getElementById('inputsTodayDate');
    if (todayEl && !todayEl.value) {
      todayEl.value = new Date().toISOString().slice(0, 10);
    }

    // Current / No-Plan A+B+C
    var aCur = apParseCurrency(apGetInputValue('currentAYellow'));
    var cCur = apParseCurrency(apGetInputValue('currentCRed'));
    var bCur = apParseCurrency(apGetInputValue('currentBGreen'));
    var totalCur = aCur + cCur + bCur;
    var curTotEl = document.getElementById('currentTotalInvestable');
    if (curTotEl) {
      curTotEl.value = apFormatCurrency(totalCur);
    }

    // Silver totals
    var aSil = apParseCurrency(apGetInputValue('silverAYellow'));
    var cSil = apParseCurrency(apGetInputValue('silverCRed'));
    var bSil = apParseCurrency(apGetInputValue('silverBGreen'));
    var totalSil = aSil + cSil + bSil;
    var silTotEl = document.getElementById('silverTotalInvestable');
    if (silTotEl) {
      silTotEl.value = apFormatCurrency(totalSil);
    }

    // Gold totals
    var aGol = apParseCurrency(apGetInputValue('goldAYellow'));
    var cGol = apParseCurrency(apGetInputValue('goldCRed'));
    var bGol = apParseCurrency(apGetInputValue('goldBGreen'));
    var totalGol = aGol + cGol + bGol;
    var golTotEl = document.getElementById('goldTotalInvestable');
    if (golTotEl) {
      golTotEl.value = apFormatCurrency(totalGol);
    }

    // Death-year indexes (approx; can be refined later)
    var projLen = parseInt(apGetInputValue('projLength') || '0', 10);
    var ageHis = parseInt(apGetInputValue('ageHis') || '0', 10);
    var ageHer = parseInt(apGetInputValue('ageHer') || '0', 10);
    var deathHis = parseInt(apGetInputValue('deathAgeHis') || '0', 10);
    var deathHer = parseInt(apGetInputValue('deathAgeHer') || '0', 10);

    if (projLen > 0 && ageHis > 0 && deathHis > ageHis) {
      var idxHis = Math.max(1, Math.min(projLen, deathHis - ageHis));
      apSetInputValue('deathIndexHis', idxHis);
    }
    if (projLen > 0 && ageHer > 0 && deathHer > ageHer) {
      var idxHer = Math.max(1, Math.min(projLen, deathHer - ageHer));
      apSetInputValue('deathIndexHer', idxHer);
    }
  }

  // ---------- Tabs + Save wiring ----------
  (function () {
    function showPanel(name) {
      var panels = ['goals', 'assets', 'inputs'];
      panels.forEach(function (p) {
        var pane = document.getElementById('ap-panel-' + p);
        if (pane) pane.style.display = (p === name ? 'block' : 'none');
      });

      var buttons = document.querySelectorAll('#ap-ifl-app .ap-ifl-tab-btn');
      buttons.forEach(function (btn) {
        btn.classList.toggle('ap-ifl-tab-active', btn.getAttribute('data-panel') === name);
      });

      if (name === 'assets') {
        apUpdateAssetSummary();
      }
      if (name === 'inputs') {
        apUpdateInputsDerived();
      }
    }

    document.addEventListener('DOMContentLoaded', function () {
      // Load previously saved data if present
      apLoadGoalsDataFromStorage();

      // Compute totals from loaded data
      apUpdateDataFormTotals();

      // Wire tabs
      var buttons = document.querySelectorAll('#ap-ifl-app .ap-ifl-tab-btn');
      buttons.forEach(function (btn) {
        btn.addEventListener('click', function () {
          showPanel(btn.getAttribute('data-panel'));
        });
      });

      // Wire Save button
      var saveBtn = document.getElementById('ap-save-data-btn');
      if (saveBtn) {
        saveBtn.addEventListener('click', function () {
          // Make sure totals are up-to-date before saving
          apUpdateDataFormTotals();
          apSaveGoalsDataToStorage();   // save to browser
          apUpdateAssetSummary();       // refresh math
          showPanel('assets');          // jump to Asset Summary tab
          alert('Client data saved in this browser and Asset Summary updated.');
        });
      }

      // Live update Data Form totals whenever anything changes on the form
      var form = document.getElementById('ap-goals-data-form');
      if (form) {
        form.addEventListener('input', function () {
          apUpdateDataFormTotals();
        });
      }

      // Default to Goals & Data
      showPanel('goals');

      // Expose for any manual calls in console
      window.apShowIFLPanel = showPanel;
    });
  })();
</script>
