<!-- AmericaPlanning – No-Plan Joint Income Page (Desktop-Only Version)
     - His Social Security column = light blue
     - Her Social Security column = light pink
     - Gap auto-calculated and negative values in red + bold
     - All inputs auto-save to browser storage and reload on revisit
-->

<div id="ap-no-plan-joint" style="max-width:1200px;margin:0 auto;padding:16px;box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;">
  <style>
    #ap-no-plan-joint * {
      box-sizing: border-box;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    }

    #ap-no-plan-joint h2 {
      margin: 0 0 8px 0;
      font-size: 24px;
      color: #0b5aa2;
      text-align: left;
      font-weight: 700;
    }

    #ap-no-plan-joint p.ap-intro {
      margin: 0 0 16px 0;
      font-size: 14px;
      line-height: 1.5;
      color: #333;
    }

    #ap-no-plan-joint .ap-note {
      font-size: 12px;
      color: #555;
      margin-bottom: 12px;
    }

    #ap-no-plan-joint .ap-table-wrapper {
      overflow-x: auto;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      padding: 8px;
      background: #f9fafb;
    }

    #ap-no-plan-joint table.ap-income-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 900px;
      background: #ffffff;
    }

    #ap-no-plan-joint table.ap-income-table thead th {
      background: #0b5aa2;
      color: #f9fafb;
      padding: 6px 4px;
      font-size: 13px;
      text-align: center;
      border: 1px solid #d1d5db;
      white-space: nowrap;
    }

    #ap-no-plan-joint table.ap-income-table tbody td {
      border: 1px solid #e5e7eb;
      padding: 4px;
      text-align: center;
      font-size: 13px;
    }

    /* His SS column (4th) – light blue */
    #ap-no-plan-joint table.ap-income-table thead th:nth-child(4),
    #ap-no-plan-joint table.ap-income-table tbody td:nth-child(4) {
      background-color: #e0f2ff;
    }

    /* Her SS column (5th) – light pink */
    #ap-no-plan-joint table.ap-income-table thead th:nth-child(5),
    #ap-no-plan-joint table.ap-income-table tbody td:nth-child(5) {
      background-color: #ffe0ef;
    }

    #ap-no-plan-joint input.ap-cell-input {
      width: 100%;
      padding: 2px 3px;
      font-size: 12px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      text-align: right;
    }

    #ap-no-plan-joint input.ap-cell-input:focus {
      outline: 2px solid #0b5aa2;
      outline-offset: 0;
    }

    #ap-no-plan-joint input.ap-cell-input.ap-year-input,
    #ap-no-plan-joint input.ap-cell-input.ap-age-input {
      text-align: center;
    }

    #ap-no-plan-joint .ap-footer-note {
      margin-top: 10px;
      font-size: 12px;
      color: #555;
      font-style: italic;
    }

    #ap-no-plan-joint .ap-gap-negative {
      color: red !important;
      font-weight: 700 !important;
    }

    #ap-no-plan-joint .ap-gap-nonnegative {
      color: inherit;
      font-weight: 400;
    }
  </style>

  <h2>No-Plan Joint Income Projection</h2>
  <p class="ap-intro">
    Use this page to view and adjust your <strong>No-Plan Joint</strong> income scenario. You can enter
    yearly amounts for His Social Security, Her Social Security, pension income, and other income.
    The table automatically calculates <strong>Total Income</strong> and the <strong>Gap</strong> between
    Total Income and your Target Income.
  </p>
  <p class="ap-note">
    <strong>Auto-Save:</strong> Everything you type on this page is saved in your browser. When you return
    on the same computer and browser, your entries will reload automatically.
  </p>

  <div class="ap-table-wrapper">
    <table id="ap-no-plan-table" class="ap-income-table">
      <thead>
        <tr>
          <th>Year</th>
          <th>Age (His)</th>
          <th>Age (Her)</th>
          <th>His Social Security</th>
          <th>Her Social Security</th>
          <th>Pension Income</th>
          <th>Other Income</th>
          <th>Total Income</th>
          <th>Target Income</th>
          <th>Gap</th>
        </tr>
      </thead>
      <tbody id="ap-no-plan-body">
        <!-- Rows are created by script -->
      </tbody>
    </table>
  </div>

  <div class="ap-footer-note">
    Note: Negative Gap values are shown in <span style="color:red;font-weight:700;">red and bold</span>.
    You can adjust income or Target Income for each year to see how the Gap changes.
  </div>
</div>

<script>
(function () {
  // ------------- CONFIG -------------
  var ROW_COUNT = 30; // how many years/rows to show

  // ------------- AUTOSAVE -------------
  var STORAGE_KEY = "IFL_NO_PLAN_JOINT_" + location.pathname;

  function getAllFields() {
    return Array.from(
      document.querySelectorAll("#ap-no-plan-joint input.ap-cell-input")
    );
  }

  function saveAutosave() {
    try {
      var fields = getAllFields();
      var data = {};
      fields.forEach(function (el) {
        var key = el.id || el.name;
        if (!key) return;
        data[key] = {
          type: "value",
          value: el.value
        };
      });
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    } catch (e) {
      if (console && console.warn) console.warn("Autosave failed:", e);
    }
  }

  function loadAutosave() {
    try {
      var raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      var data = JSON.parse(raw);
      var fields = getAllFields();
      fields.forEach(function (el) {
        var key = el.id || el.name;
        if (!key || !(key in data)) return;
        var saved = data[key];
        if (saved && typeof saved.value !== "undefined") {
          el.value = saved.value;
        }
      });
    } catch (e) {
      if (console && console.warn) console.warn("Load autosave failed:", e);
    }
  }

  // ------------- TABLE / CALCS -------------

  function parseNum(val) {
    if (val == null) return 0;
    var cleaned = String(val).replace(/[,$\s]/g, "");
    if (cleaned === "") return 0;
    var n = parseFloat(cleaned);
    return isNaN(n) ? 0 : n;
  }

  function formatMoney(val) {
    if (isNaN(val)) return "";
    var fixed = Math.round(val);
    return fixed.toLocaleString("en-US");
  }

  function recalcAllRows() {
    var rows = document.querySelectorAll("#ap-no-plan-table tbody tr");
    rows.forEach(function (row) {
      var hisSS = row.querySelector("input.ap-his-ss");
      var herSS = row.querySelector("input.ap-her-ss");
      var pension = row.querySelector("input.ap-pension");
      var other = row.querySelector("input.ap-other");
      var total = row.querySelector("input.ap-total");
      var target = row.querySelector("input.ap-target");
      var gap = row.querySelector("input.ap-gap");

      var hisVal = hisSS ? parseNum(hisSS.value) : 0;
      var herVal = herSS ? parseNum(herSS.value) : 0;
      var penVal = pension ? parseNum(pension.value) : 0;
      var othVal = other ? parseNum(other.value) : 0;

      var totalVal = hisVal + herVal + penVal + othVal;
      if (total) {
        total.value = formatMoney(totalVal);
      }

      var targetVal = target ? parseNum(target.value) : 0;
      var gapVal = totalVal - targetVal;

      if (gap) {
        gap.value = gap.value === "" && gapVal === 0 ? "" : formatMoney(gapVal);

        // Negative Gap styling
        if (gapVal < 0) {
          gap.classList.add("ap-gap-negative");
          gap.classList.remove("ap-gap-nonnegative");
        } else {
          gap.classList.remove("ap-gap-negative");
          gap.classList.add("ap-gap-nonnegative");
        }
      }
    });
  }

  function handleFieldChange() {
    saveAutosave();
    recalcAllRows();
  }

  function createInputCell(row, id, extraClass) {
    var td = document.createElement("td");
    var input = document.createElement("input");
    input.type = "text";
    input.id = id;
    input.name = id;
    input.className = "ap-cell-input " + (extraClass || "");
    td.appendChild(input);
    row.appendChild(td);
  }

  function buildTableRows() {
    var tbody = document.getElementById("ap-no-plan-body");
    if (!tbody) return;

    tbody.innerHTML = "";

    for (var i = 0; i < ROW_COUNT; i++) {
      var row = document.createElement("tr");

      // Year
      createInputCell(row, "np_year_" + i, "ap-year-input");

      // Age (His)
      createInputCell(row, "np_age_his_" + i, "ap-age-input");

      // Age (Her)
      createInputCell(row, "np_age_her_" + i, "ap-age-input");

      // His Social Security
      createInputCell(row, "np_his_ss_" + i, "ap-his-ss");

      // Her Social Security
      createInputCell(row, "np_her_ss_" + i, "ap-her-ss");

      // Pension Income
      createInputCell(row, "np_pension_" + i, "ap-pension");

      // Other Income
      createInputCell(row, "np_other_" + i, "ap-other");

      // Total Income (read-only)
      var tdTotal = document.createElement("td");
      var inputTotal = document.createElement("input");
      inputTotal.type = "text";
      inputTotal.id = "np_total_" + i;
      inputTotal.name = "np_total_" + i;
      inputTotal.className = "ap-cell-input ap-total";
      inputTotal.readOnly = true;
      tdTotal.appendChild(inputTotal);
      row.appendChild(tdTotal);

      // Target Income
      createInputCell(row, "np_target_" + i, "ap-target");

      // Gap (read-only)
      var tdGap = document.createElement("td");
      var inputGap = document.createElement("input");
      inputGap.type = "text";
      inputGap.id = "np_gap_" + i;
      inputGap.name = "np_gap_" + i;
      inputGap.className = "ap-cell-input ap-gap";
      inputGap.readOnly = true;
      tdGap.appendChild(inputGap);
      row.appendChild(tdGap);

      tbody.appendChild(row);
    }
  }

  // ------------- INIT -------------

  document.addEventListener("DOMContentLoaded", function () {
    // Build the empty rows first
    buildTableRows();

    // Restore autosaved values
    loadAutosave();

    // Recalc totals/gaps based on any restored values
    recalcAllRows();

    // Attach change handlers
    document
      .getElementById("ap-no-plan-joint")
      .addEventListener("input", handleFieldChange, true);

    document
      .getElementById("ap-no-plan-joint")
      .addEventListener("change", handleFieldChange, true);
  });
})();
</script>
