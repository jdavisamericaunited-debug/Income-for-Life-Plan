<script>
  // ---------- Tabs + wiring ----------
  (function () {
    function showPanel(name) {
      // List of all panel IDs
      var panels = ['goals', 'assets', 'inputs', 'noplanJoint', 'noplanHer', 'noplanHis', 'noplanAlloc'];

      // Hide all panels
      panels.forEach(function (p) {
        var pane = document.getElementById('ap-panel-' + p);
        if (pane) {
          pane.style.display = (p === name ? 'block' : 'none');
        }
      });

      // Reset tab styles and mark active tab
      var buttons = document.querySelectorAll('#ap-ifl-app .ap-ifl-tab-btn');
      buttons.forEach(function (btn) {
        btn.classList.toggle('ap-ifl-tab-active', btn.getAttribute('data-panel') === name);
      });

      // Update content based on selected panel
      if (name === 'assets') {
        apUpdateAssetSummary();
      }
      if (name === 'inputs') {
        apUpdateInputsDerived();
      }
      if (name === 'noplanJoint' || name === 'noplanHer' || name === 'noplanHis' || name === 'noplanAlloc') {
        apUpdateInputsDerived();
        apRenderNoPlanProjections();
      }
    }

    document.addEventListener('DOMContentLoaded', function () {
      apLoadGoalsDataFromStorage();
      apUpdateDataFormTotals();

      // Add event listeners to tab buttons
      var buttons = document.querySelectorAll('#ap-ifl-app .ap-ifl-tab-btn');
      buttons.forEach(function (btn) {
        btn.addEventListener('click', function () {
          showPanel(btn.getAttribute('data-panel'));
        });
      });

      // Save button to save data and switch to asset summary
      var saveBtn = document.getElementById('ap-save-data-btn');
      if (saveBtn) {
        saveBtn.addEventListener('click', function () {
          apUpdateDataFormTotals();
          apSaveGoalsDataToStorage();
          apUpdateAssetSummary();
          showPanel('assets');
          alert('Client data saved in this browser and Asset Summary updated.');
        });
      }

      // Form input events to update totals as user types
      var form = document.getElementById('ap-goals-data-form');
      if (form) {
        form.addEventListener('input', function () {
          apUpdateDataFormTotals();
        });
      }

      // Inputs root listener to handle changes for Silver/Gold and other fields
      var inputsRoot = document.getElementById('ap-plan-inputs');
      if (inputsRoot) {
        inputsRoot.addEventListener('input', function (e) {
          var id = e.target.id || '';
          if (
            id.indexOf('silver') === 0 ||
            id.indexOf('gold') === 0 ||
            id === 'projLength' ||
            id === 'ageHis' ||
            id === 'ageHer' ||
            id === 'deathAgeHis' ||
            id === 'deathAgeHer' ||
            id === 'currentAYellow' ||
            id === 'currentCRed' ||
            id === 'currentBGreen' ||
            id === 'ssHisAnnual' || id === 'ssHerAnnual' ||
            id === 'ssHisStartAge' || id === 'ssHerStartAge' ||
            id === 'pension1Annual' || id === 'pension2Annual' ||
            id === 'pension1StartAge' || id === 'pension2StartAge' ||
            id === 'pension1SurvivorPct' || id === 'pension2SurvivorPct' ||
            id === 'otherIncomeAnnual' || id === 'livingExpensesAnnual' ||
            id === 'incomeGrowthPct' || id === 'expenseInflationPct'
          ) {
            apUpdateInputsDerived();
            apRenderNoPlanProjections();
          }
        });
      }

      // Show the initial panel (Goals)
      showPanel('goals');
      window.apShowIFLPanel = showPanel;
    });
  })();
</script>
