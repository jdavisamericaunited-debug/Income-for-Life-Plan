<!-- AmericaPlanning – Income-for-Life Plan (Desktop-First Embed) -->
<div id="ap-ifl-embed">
  <style>
    #ap-ifl-embed,
    #ap-ifl-embed * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    #ap-ifl-embed {
      max-width: 1400px; /* desktop width */
      margin: 0 auto;
      padding: 16px 8px 40px;
      color: #111827;
    }

    /* App shell */
    #ap-ifl-embed #ap-app {
      background: #f3f4f6;
      border-radius: 16px;
      padding: 18px 20px 26px;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.1);
    }

    /* Header */
    #ap-ifl-embed .ap-header {
      border-bottom: 3px solid #0b5aa2;
      padding-bottom: 10px;
      margin-bottom: 16px;
    }

    #ap-ifl-embed .ap-header-inner {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      flex-wrap: nowrap;
    }

    #ap-ifl-embed .ap-logo-lockup {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    #ap-ifl-embed .ap-logo-circle {
      width: 46px;
      height: 46px;
      border-radius: 999px;
      background: linear-gradient(135deg, #0b5aa2, #1d4ed8);
      color: #f9fafb;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 19px;
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.35);
    }

    #ap-ifl-embed .ap-logo-title {
      font-size: 17px;
      font-weight: 700;
      color: #111827;
    }

    #ap-ifl-embed .ap-logo-subtitle {
      font-size: 13px;
      color: #4b5563;
    }

    #ap-ifl-embed .ap-header-contact {
      text-align: right;
      font-size: 13px;
      color: #374151;
      white-space: nowrap;
    }

    /* Step nav */
    #ap-ifl-embed .ap-steps {
      display: flex;
      flex-wrap: nowrap;
      gap: 6px;
      margin: 14px 0 16px;
    }

    #ap-ifl-embed .ap-step-btn {
      flex: 1 1 0;
      border-radius: 999px;
      padding: 8px 10px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      font-size: 13px;
      font-weight: 600;
      color: #374151;
      cursor: pointer;
      transition: all 0.15s ease;
      text-align: center;
    }

    #ap-ifl-embed .ap-step-btn:hover {
      border-color: #0b5aa2;
      background: #eff6ff;
    }

    #ap-ifl-embed .ap-step-btn-active {
      background: #0b5aa2;
      border-color: #0b5aa2;
      color: #f9fafb;
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.25);
    }

    /* Cards */
    #ap-ifl-embed .ap-card {
      background: #ffffff;
      border-radius: 14px;
      padding: 18px 16px 20px;
      margin-bottom: 16px;
      border: 1px solid #e5e7eb;
    }

    #ap-ifl-embed .ap-card-hidden {
      display: none;
    }

    #ap-ifl-embed .ap-card h1 {
      font-size: 20px;
      margin-bottom: 6px;
      color: #111827;
    }

    #ap-ifl-embed .ap-intro {
      font-size: 14px;
      color: #4b5563;
      margin-bottom: 16px;
    }

    /* Sections */
    #ap-ifl-embed .ap-form-section {
      margin-top: 12px;
      margin-bottom: 16px;
      padding: 10px 10px 12px;
      border-radius: 10px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
    }

    #ap-ifl-embed .ap-form-section h2 {
      font-size: 15px;
      margin: 0 0 8px;
      color: #111827;
    }

    #ap-ifl-embed .ap-help {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 10px;
    }

    /* Grids – desktop wide */
    #ap-ifl-embed .ap-form-grid {
      display: grid;
      gap: 10px 14px;
    }

    #ap-ifl-embed .ap-form-grid-2 {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    #ap-ifl-embed .ap-form-grid-3 {
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }

    #ap-ifl-embed .ap-form-grid-4 {
      grid-template-columns: repeat(4, minmax(0, 1fr));
    }

    #ap-ifl-embed label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 3px;
    }

    #ap-ifl-embed input[type="text"],
    #ap-ifl-embed input[type="number"],
    #ap-ifl-embed input[type="date"] {
      width: 100%;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      padding: 6px 8px;
      font-size: 13px;
      color: #111827;
      background: #ffffff;
      outline: none;
      transition: border-color 0.12s ease, box-shadow 0.12s ease;
    }

    #ap-ifl-embed input[type="text"]:focus,
    #ap-ifl-embed input[type="number"]:focus,
    #ap-ifl-embed input[type="date"]:focus {
      border-color: #0b5aa2;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.22);
    }

    /* Tables */
    #ap-ifl-embed .ap-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 8px;
      background: #ffffff;
    }

    #ap-ifl-embed .ap-table th,
    #ap-ifl-embed .ap-table td {
      border: 1px solid #e5e7eb;
      padding: 6px 6px;
      text-align: right;
      white-space: nowrap;
    }

    #ap-ifl-embed .ap-table th:nth-child(1),
    #ap-ifl-embed .ap-table td:nth-child(1) {
      text-align: left;
    }

    #ap-ifl-embed .ap-table thead th {
      background: #f3f4f6;
      font-weight: 600;
      color: #374151;
    }

    #ap-ifl-embed .plan-schedule-wrapper {
      overflow-x: auto;
      margin-top: 6px;
    }

    /* Actions */
    #ap-ifl-embed .ap-form-actions {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 12px;
      flex-wrap: nowrap;
    }

    #ap-ifl-embed .ap-primary-btn {
      border: none;
      border-radius: 999px;
      padding: 8px 18px;
      font-size: 14px;
      font-weight: 700;
      background: linear-gradient(135deg, #0b5aa2, #1d4ed8);
      color: #f9fafb;
      cursor: pointer;
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.25);
      transition: transform 0.08s ease, box-shadow 0.08s ease, filter 0.08s ease;
      white-space: nowrap;
    }

    #ap-ifl-embed .ap-primary-btn:hover {
      filter: brightness(1.05);
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(15, 23, 42, 0.3);
    }

    #ap-ifl-embed .ap-primary-btn:active {
      transform: translateY(0);
      box-shadow: 0 5px 12px rgba(15, 23, 42, 0.2);
    }

    #ap-ifl-embed .ap-save-status {
      font-size: 12px;
      color: #16a34a;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    #ap-ifl-embed .ap-save-status-visible {
      opacity: 1;
    }

    /* Plan tabs */
    #ap-ifl-embed .plan-tabs {
      display: inline-flex;
      flex-wrap: nowrap;
      gap: 4px;
      margin: 6px 0 10px;
    }

    #ap-ifl-embed .plan-tab {
      border-radius: 999px;
      padding: 5px 12px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      font-size: 12px;
      font-weight: 600;
      color: #374151;
      cursor: pointer;
      transition: all 0.15s ease;
      white-space: nowrap;
    }

    #ap-ifl-embed .plan-tab-active {
      background: #111827;
      border-color: #111827;
      color: #f9fafb;
    }

    #ap-ifl-embed .plan-card {
      margin-top: 10px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
    }

    #ap-ifl-embed .plan-card-hidden {
      display: none;
    }

    #ap-ifl-embed .plan-card-header {
      padding: 8px 12px;
      border-bottom: 1px solid #e5e7eb;
      font-size: 14px;
      font-weight: 700;
      background: linear-gradient(90deg, #0b5aa2, #1d4ed8);
      color: #f9fafb;
    }

    #ap-ifl-embed .plan-card-body {
      padding: 10px 10px 12px;
    }

    #ap-ifl-embed .plan-metric-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
      margin-bottom: 8px;
    }

    #ap-ifl-embed .plan-metric {
      background: #eff6ff;
      border-radius: 10px;
      padding: 6px 8px;
      border: 1px solid #dbeafe;
    }

    #ap-ifl-embed .plan-metric-label {
      font-size: 11px;
      color: #1f2937;
      margin-bottom: 2px;
    }

    #ap-ifl-embed .plan-metric-value {
      font-size: 15px;
      font-weight: 700;
      color: #111827;
    }

    #ap-ifl-embed .plan-note {
      font-size: 12px;
      color: #4b5563;
      margin: 4px 0 8px;
    }

    /* Asset chips / legend */
    #ap-ifl-embed .asset-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 11px;
      margin-bottom: 4px;
    }

    #ap-ifl-embed .asset-chip {
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 11px;
      font-weight: 600;
      color: #111827;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: 1px solid transparent;
      white-space: nowrap;
    }

    #ap-ifl-embed .asset-chip-investments {
      background: #fee2e2;
      border-color: #fecaca;
      color: #991b1b;
    }

    #ap-ifl-embed .asset-chip-savings {
      background: #fef9c3;
      border-color: #fef3c7;
      color: #854d0e;
    }

    #ap-ifl-embed .asset-chip-annuities {
      background: #dcfce7;
      border-color: #bbf7d0;
      color: #166534;
    }

    /* ABC summary + pie */
    #ap-ifl-embed .plan-summary-heading {
      font-size: 14px;
      margin: 10px 0 6px;
      color: #111827;
    }

    #ap-ifl-embed .plan-summary-layout {
      display: grid;
      grid-template-columns: minmax(0, 1.5fr) minmax(0, 1fr);
      gap: 10px;
      align-items: stretch;
    }

    #ap-ifl-embed .plan-income-summary {
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      padding: 8px 8px 6px;
      font-size: 12px;
    }

    #ap-ifl-embed .summary-abc-row {
      display: flex;
      gap: 10px;
      margin-bottom: 6px;
    }

    #ap-ifl-embed .summary-abc-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    #ap-ifl-embed .summary-abc-label {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      color: #ffffff;
    }

    #ap-ifl-embed .summary-a { background: #eab308; }
    #ap-ifl-embed .summary-b { background: #16a34a; }
    #ap-ifl-embed .summary-c { background: #b91c1c; }

    #ap-ifl-embed .summary-abc-value {
      font-weight: 700;
      font-size: 13px;
      color: #111827;
    }

    #ap-ifl-embed .plan-income-row {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      margin-top: 3px;
    }

    #ap-ifl-embed .plan-income-row .label {
      color: #4b5563;
    }

    #ap-ifl-embed .plan-income-row.main .label {
      font-weight: 700;
      color: #111827;
    }

    #ap-ifl-embed .plan-income-row.her .label {
      color: #7c3aed;
    }

    #ap-ifl-embed .plan-income-row.his .label {
      color: #0ea5e9;
    }

    #ap-ifl-embed .plan-pie-wrapper {
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      padding: 8px;
      min-height: 220px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #ap-ifl-embed .plan-pie-canvas {
      width: 100% !important;
      height: 220px !important;
    }

    /* Bullets on Summary page */
    #ap-ifl-embed .ap-bullets {
      padding-left: 18px;
      font-size: 13px;
      color: #4b5563;
      margin-bottom: 10px;
    }

    #ap-ifl-embed .ap-bullets li {
      margin-bottom: 4px;
    }

    /* Footer */
    #ap-ifl-embed .ap-footer {
      font-size: 11px;
      color: #6b7280;
      text-align: center;
      margin-top: 16px;
    }

    #ap-ifl-embed .ap-footer div + div {
      margin-top: 2px;
    }
  </style>

  <!-- NO mobile rotate tip (desktop-only) -->

  <div id="ap-app">
    <header class="ap-header">
      <div class="ap-header-inner">
        <div class="ap-logo-lockup">
          <div class="ap-logo-circle">AP</div>
          <div>
            <div class="ap-logo-title">America United Wealth Planning</div>
            <div class="ap-logo-subtitle">Income-for-Life Plan</div>
          </div>
        </div>
        <div class="ap-header-contact">
          <div>AmericaPlanning.com</div>
          <div>847-592-5405</div>
        </div>
      </div>
    </header>

    <main class="ap-main">
      <!-- Step indicator -->
      <nav class="ap-steps">
        <button class="ap-step-btn ap-step-btn-active" data-step="client">
          1. Client Goals &amp; Data
        </button>
        <button class="ap-step-btn" data-step="assets">
          2. Asset Summary
        </button>
        <button class="ap-step-btn" data-step="inputs">
          3. Plan Inputs
        </button>
        <button class="ap-step-btn" data-step="plans">
          4. Plan Comparisons
        </button>
        <button class="ap-step-btn" data-step="summary">
          5. Summary &amp; Report
        </button>
      </nav>

      <!-- STEP 1: CLIENT GOALS & DATA -->
      <section id="step-client" class="ap-card">
        <h1>Client Goals &amp; Data</h1>
        <p class="ap-intro">
          Enter the key facts from your <strong>Goals &amp; Data</strong> worksheet.
          These values feed the rest of the Income-for-Life Plan.
        </p>

        <form id="client-form">
          <div class="ap-form-section">
            <h2>Client Information</h2>
            <div class="ap-form-grid ap-form-grid-2">
              <div>
                <label for="clientName">Client Name</label>
                <input id="clientName" type="text" />
              </div>
              <div>
                <label for="spouseName">Spouse Name</label>
                <input id="spouseName" type="text" />
              </div>
              <div>
                <label for="advisorName">Advisor</label>
                <input id="advisorName" type="text" />
              </div>
              <div>
                <label for="planDate">Plan Date</label>
                <input id="planDate" type="date" />
              </div>
            </div>
          </div>

          <div class="ap-form-section">
            <h2>Residence &amp; Real Estate</h2>
            <div class="ap-form-grid ap-form-grid-2">
              <div>
                <label for="primaryValue">Primary Residence – Value</label>
                <input id="primaryValue" type="number" inputmode="decimal" />
              </div>
              <div>
                <label for="primaryMortgage">Primary Residence – Mortgage</label>
                <input id="primaryMortgage" type="number" inputmode="decimal" />
              </div>
              <div>
                <label for="secondaryValue">2nd Home / Rental – Value</label>
                <input id="secondaryValue" type="number" inputmode="decimal" />
              </div>
              <div>
                <label for="secondaryMortgage">2nd Home / Rental – Mortgage</label>
                <input id="secondaryMortgage" type="number" inputmode="decimal" />
              </div>
            </div>
          </div>

          <div class="ap-form-section">
            <h2>Investment Accounts (C – Red)</h2>
            <p class="ap-help">Typical examples: IRAs, 401(k)s, brokerage accounts.</p>
            <div class="ap-form-grid ap-form-grid-3">
              <div>
                <label for="inv1Balance">Investment 1 – Balance</label>
                <input id="inv1Balance" type="number" inputmode="decimal" />
              </div>
              <div>
                <label for="inv2Balance">Investment 2 – Balance</label>
                <input id="inv2Balance" type="number" inputmode="decimal" />
              </div>
              <div>
                <label for="inv3Balance">Investment 3 – Balance</label>
                <input id="inv3Balance" type="number" inputmode="decimal" />
              </div>
              <div>
                <label for="inv4Balance">Investment 4 – Balance</label>
                <input id="inv4Balance" type="number" inputmode="decimal" />
              </div>
              <div>
                <label for="inv5Balance">Investment 5 – Balance</label>
                <input id="inv5Balance" type="number" inputmode="decimal" />
              </div>
            </div>
          </div>

          <div class="ap-form-section">
            <h2>Savings / Checking / Credit Union (A – Yellow)</h2>
            <div class="ap-form-grid ap-form-grid-3">
              <div>
                <label for="sav1Balance">Account 1 – Balance</label>
                <input id="sav1Balance" type="number" inputmode="decimal" />
              </div>
              <div>
                <label for="sav2Balance">Account 2 – Balance</label>
                <input id="sav2Balance" type="number" inputmode="decimal" />
              </div>
              <div>
                <label for="sav3Balance">Account 3 – Balance</label>
                <input id="sav3Balance" type="number" inputmode="decimal" />
              </div>
              <div>
                <label for="sav4Balance">Account 4 – Balance</label>
                <input id="sav4Balance" type="number" inputmode="decimal" />
              </div>
              <div>
                <label for="sav5Balance">Account 5 – Balance</label>
                <input id="sav5Balance" type="number" inputmode="decimal" />
              </div>
            </div>
          </div>

          <div class="ap-form-section">
            <h2>Annuities (B – Green)</h2>
            <div class="ap-form-grid ap-form-grid-3">
              <div>
                <label for="ann1Balance">Annuity 1 – Account Value</label>
                <input id="ann1Balance" type="number" inputmode="decimal" />
              </div>
              <div>
                <label for="ann2Balance">Annuity 2 – Account Value</label>
                <input id="ann2Balance" type="number" inputmode="decimal" />
              </div>
              <div>
                <label for="ann3Balance">Annuity 3 – Account Value</label>
                <input id="ann3Balance" type="number" inputmode="decimal" />
              </div>
              <div>
                <label for="ann4Balance">Annuity 4 – Account Value</label>
                <input id="ann4Balance" type="number" inputmode="decimal" />
              </div>
              <div>
                <label for="ann5Balance">Annuity 5 – Account Value</label>
                <input id="ann5Balance" type="number" inputmode="decimal" />
              </div>
            </div>
          </div>

          <div class="ap-form-actions">
            <button type="submit" class="ap-primary-btn">
              Save Client Data
            </button>
            <span id="saveStatus" class="ap-save-status"></span>
          </div>
        </form>
      </section>

      <!-- STEP 2: ASSET SUMMARY -->
      <section id="step-assets" class="ap-card ap-card-hidden">
        <h1>Asset Summary – Balance Sheet</h1>
        <p class="ap-intro">
          This page summarizes the assets you entered on the Goals &amp; Data page.
          It mirrors the balance sheet and feeds the A/B/C charts later.
        </p>

        <div class="ap-form-section">
          <h2>Real Estate</h2>
          <table class="ap-table">
            <thead>
              <tr>
                <th>Property</th>
                <th>Value</th>
                <th>Mortgage</th>
                <th>Equity</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Primary Residence</td>
                <td id="as-primary-value">$0</td>
                <td id="as-primary-mortgage">$0</td>
                <td id="as-primary-equity">$0</td>
              </tr>
              <tr>
                <td>2nd Home / Rental</td>
                <td id="as-secondary-value">$0</td>
                <td id="as-secondary-mortgage">$0</td>
                <td id="as-secondary-equity">$0</td>
              </tr>
              <tr>
                <th colspan="3">Total Real Estate Equity</th>
                <th id="as-total-real-estate-equity">$0</th>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="ap-form-section">
          <h2>Financial Assets</h2>
          <table class="ap-table">
            <thead>
              <tr>
                <th>Category</th>
                <th>Number of Accounts</th>
                <th>Total Balance</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Investment Accounts (C – Red)</td>
                <td id="as-portfolio-count">0</td>
                <td id="as-portfolio-total">$0</td>
              </tr>
              <tr>
                <td>Savings / Checking / CU (A – Yellow)</td>
                <td id="as-savings-count">0</td>
                <td id="as-savings-total">$0</td>
              </tr>
              <tr>
                <td>Annuities (B – Green)</td>
                <td id="as-annuities-count">0</td>
                <td id="as-annuities-total">$0</td>
              </tr>
              <tr>
                <th colspan="2">Total Financial Assets</th>
                <th id="as-total-financial-assets">$0</th>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="ap-form-section">
          <h2>Total Assets</h2>
          <p>
            <strong>Total Assets (Real Estate Equity + Financial Assets):</strong>
            <span id="as-total-assets">$0</span>
          </p>
        </div>
      </section>

      <!-- STEP 3: PLAN INPUTS -->
      <section id="step-inputs" class="ap-card ap-card-hidden">
        <h1>Plan Inputs</h1>
        <p class="ap-intro">
          Enter the retirement income assumptions used to build your
          <strong>No Plan</strong>, <strong>Silver Plan</strong>, and
          <strong>Gold Plan</strong> illustrations.
        </p>

        <div class="ap-form-section">
          <h2>Ages &amp; Projection</h2>
          <div class="ap-form-grid ap-form-grid-3">
            <div>
              <label for="piHisCurrentAge">His Current Age</label>
              <input id="piHisCurrentAge" type="number" inputmode="decimal" />
            </div>
            <div>
              <label for="piHerCurrentAge">Her Current Age</label>
              <input id="piHerCurrentAge" type="number" inputmode="decimal" />
            </div>
            <div>
              <label for="piProjectionYears">Projection Years</label>
              <input id="piProjectionYears" type="number" inputmode="decimal" value="30" />
            </div>
            <div>
              <label for="piHisDeathAge">His Assumed Death Age</label>
              <input id="piHisDeathAge" type="number" inputmode="decimal" />
            </div>
            <div>
              <label for="piHerDeathAge">Her Assumed Death Age</label>
              <input id="piHerDeathAge" type="number" inputmode="decimal" />
            </div>
          </div>
        </div>

        <div class="ap-form-section">
          <h2>Social Security</h2>
          <div class="ap-form-grid ap-form-grid-3">
            <div>
              <label for="piHisSSAnnual">His Social Security (Annual at Start)</label>
              <input id="piHisSSAnnual" type="number" inputmode="decimal" />
            </div>
            <div>
              <label for="piHerSSAnnual">Her Social Security (Annual at Start)</label>
              <input id="piHerSSAnnual" type="number" inputmode="decimal" />
            </div>
            <div>
              <label for="piSSGrowthPct">COLA % (applied to SS only)</label>
              <input id="piSSGrowthPct" type="number" inputmode="decimal" value="2" />
            </div>
            <div>
              <label for="piHisSSStartAge">His SS Start Age</label>
              <input id="piHisSSStartAge" type="number" inputmode="decimal" />
            </div>
            <div>
              <label for="piHerSSStartAge">Her SS Start Age</label>
              <input id="piHerSSStartAge" type="number" inputmode="decimal" />
            </div>
          </div>
          <p class="ap-help">
            Survivor logic: when one spouse dies, the lower Social Security benefit
            drops off and the higher benefit continues for the survivor.
          </p>
        </div>

        <div class="ap-form-section">
          <h2>Pensions &amp; Other Income</h2>
          <div class="ap-form-grid ap-form-grid-3">
            <div>
              <label for="piPension1Annual">Pension 1 – Annual at Start</label>
              <input id="piPension1Annual" type="number" inputmode="decimal" />
            </div>
            <div>
              <label for="piPension1StartAge">Pension 1 – Start Age</label>
              <input id="piPension1StartAge" type="number" inputmode="decimal" />
            </div>
            <div>
              <label for="piPension1SurvivorPct">Pension 1 – Survivor % (e.g. 100 or 50)</label>
              <input id="piPension1SurvivorPct" type="number" inputmode="decimal" value="100" />
            </div>

            <div>
              <label for="piPension2Annual">Pension 2 – Annual at Start</label>
              <input id="piPension2Annual" type="number" inputmode="decimal" />
            </div>
            <div>
              <label for="piPension2StartAge">Pension 2 – Start Age</label>
              <input id="piPension2StartAge" type="number" inputmode="decimal" />
            </div>
            <div>
              <label for="piPension2SurvivorPct">Pension 2 – Survivor % (e.g. 100 or 50)</label>
              <input id="piPension2SurvivorPct" type="number" inputmode="decimal" value="100" />
            </div>

            <div>
              <label for="piPensionGrowthPct">Pension Increase % (optional)</label>
              <input id="piPensionGrowthPct" type="number" inputmode="decimal" value="0" />
            </div>
            <div>
              <label for="piOtherIncomeAnnual">Other Income (Annual)</label>
              <input id="piOtherIncomeAnnual" type="number" inputmode="decimal" />
            </div>
          </div>
        </div>

        <div class="ap-form-section">
          <h2>Living Expenses</h2>
          <div class="ap-form-grid ap-form-grid-3">
            <div>
              <label for="piLivingExpensesAnnual">Annual Living Expenses (Today)</label>
              <input id="piLivingExpensesAnnual" type="number" inputmode="decimal" />
            </div>
            <div>
              <label for="piExpenseInflationPct">Expense Inflation %</label>
              <input id="piExpenseInflationPct" type="number" inputmode="decimal" value="2" />
            </div>
          </div>
        </div>

        <div class="ap-form-section">
          <h2>Silver Plan – Lifetime Income Sources</h2>
          <p class="ap-help">
            Enter the income streams and rollover amounts that define your Silver Plan.
            Income from these annuities is treated as level and continues to the survivor.
          </p>
          <div class="ap-form-grid ap-form-grid-4">
            <!-- Silver 1 -->
            <div>
              <label for="piSilver1Desc">Silver 1 – Description / Carrier</label>
              <input id="piSilver1Desc" type="text" />
            </div>
            <div>
              <label for="piSilver1Owner">Owner (His, Her, or Joint)</label>
              <input id="piSilver1Owner" type="text" />
            </div>
            <div>
              <label for="piSilver1StartAge">Start Age</label>
              <input id="piSilver1StartAge" type="number" inputmode="decimal" />
            </div>
            <div>
              <label for="piSilver1Annual">Annual Lifetime Income</label>
              <input id="piSilver1Annual" type="number" inputmode="decimal" />
            </div>
            <div>
              <label for="piSilver1Rollover">Rollover from Investments</label>
              <input id="piSilver1Rollover" type="number" inputmode="decimal" />
            </div>

            <!-- Silver 2 -->
            <div>
              <label for="piSilver2Desc">Silver 2 – Description / Carrier</label>
              <input id="piSilver2Desc" type="text" />
            </div>
            <div>
              <label for="piSilver2Owner">Owner (His, Her, or Joint)</label>
              <input id="piSilver2Owner" type="text" />
            </div>
            <div>
              <label for="piSilver2StartAge">Start Age</label>
              <input id="piSilver2StartAge" type="number" inputmode="decimal" />
            </div>
            <div>
              <label for="piSilver2Annual">Annual Lifetime Income</label>
              <input id="piSilver2Annual" type="number" inputmode="decimal" />
            </div>
            <div>
              <label for="piSilver2Rollover">Rollover from Investments</label>
              <input id="piSilver2Rollover" type="number" inputmode="decimal" />
            </div>

            <!-- Silver 3 -->
            <div>
              <label for="piSilver3Desc">Silver 3 – Description / Carrier</label>
              <input id="piSilver3Desc" type="text" />
            </div>
            <div>
              <label for="piSilver3Owner">Owner (His, Her, or Joint)</label>
              <input id="piSilver3Owner" type="text" />
            </div>
            <div>
              <label for="piSilver3StartAge">Start Age</label>
              <input id="piSilver3StartAge" type="number" inputmode="decimal" />
            </div>
            <div>
              <label for="piSilver3Annual">Annual Lifetime Income</label>
              <input id="piSilver3Annual" type="number" inputmode="decimal" />
            </div>
            <div>
              <label for="piSilver3Rollover">Rollover from Investments</label>
              <input id="piSilver3Rollover" type="number" inputmode="decimal" />
            </div>

            <!-- Silver 4 -->
            <div>
              <label for="piSilver4Desc">Silver 4 – Description / Carrier</label>
              <input id="piSilver4Desc" type="text" />
            </div>
            <div>
              <label for="piSilver4Owner">Owner (His, Her, or Joint)</label>
              <input id="piSilver4Owner" type="text" />
            </div>
            <div>
              <label for="piSilver4StartAge">Start Age</label>
              <input id="piSilver4StartAge" type="number" inputmode="decimal" />
            </div>
            <div>
              <label for="piSilver4Annual">Annual Lifetime Income</label>
              <input id="piSilver4Annual" type="number" inputmode="decimal" />
            </div>
            <div>
              <label for="piSilver4Rollover">Rollover from Investments</label>
              <input id="piSilver4Rollover" type="number" inputmode="decimal" />
            </div>
          </div>
        </div>

        <div class="ap-form-section">
          <h2>Gold Plan – Lifetime Income Sources</h2>
          <p class="ap-help">
            Gold Plan typically uses larger or additional rollovers to maximize guaranteed income.
            These are modeled as an alternative to the Silver Plan.
          </p>
          <div class="ap-form-grid ap-form-grid-4">
            <!-- Gold 1 -->
            <div>
              <label for="piGold1Desc">Gold 1 – Description / Carrier</label>
              <input id="piGold1Desc" type="text" />
            </div>
            <div>
              <label for="piGold1Owner">Owner (His, Her, or Joint)</label>
              <input id="piGold1Owner" type="text" />
            </div>
            <div>
              <label for="piGold1StartAge">Start Age</label>
              <input id="piGold1StartAge" type="number" inputmode="decimal" />
            </div>
            <div>
              <label for="piGold1Annual">Annual Lifetime Income</label>
              <input id="piGold1Annual" type="number" inputmode="decimal" />
            </div>
            <div>
              <label for="piGold1Rollover">Rollover from Investments</label>
              <input id="piGold1Rollover" type="number" inputmode="decimal" />
            </div>

            <!-- Gold 2 -->
            <div>
              <label for="piGold2Desc">Gold 2 – Description / Carrier</label>
              <input id="piGold2Desc" type="text" />
            </div>
            <div>
              <label for="piGold2Owner">Owner (His, Her, or Joint)</label>
              <input id="piGold2Owner" type="text" />
            </div>
            <div>
              <label for="piGold2StartAge">Start Age</label>
              <input id="piGold2StartAge" type="number" inputmode="decimal" />
            </div>
            <div>
              <label for="piGold2Annual">Annual Lifetime Income</label>
              <input id="piGold2Annual" type="number" inputmode="decimal" />
            </div>
            <div>
              <label for="piGold2Rollover">Rollover from Investments</label>
              <input id="piGold2Rollover" type="number" inputmode="decimal" />
            </div>

            <!-- Gold 3 -->
            <div>
              <label for="piGold3Desc">Gold 3 – Description / Carrier</label>
              <input id="piGold3Desc" type="text" />
            </div>
            <div>
              <label for="piGold3Owner">Owner (His, Her, or Joint)</label>
              <input id="piGold3Owner" type="text" />
            </div>
            <div>
              <label for="piGold3StartAge">Start Age</label>
              <input id="piGold3StartAge" type="number" inputmode="decimal" />
            </div>
            <div>
              <label for="piGold3Annual">Annual Lifetime Income</label>
              <input id="piGold3Annual" type="number" inputmode="decimal" />
            </div>
            <div>
              <label for="piGold3Rollover">Rollover from Investments</label>
              <input id="piGold3Rollover" type="number" inputmode="decimal" />
            </div>

            <!-- Gold 4 -->
            <div>
              <label for="piGold4Desc">Gold 4 – Description / Carrier</label>
              <input id="piGold4Desc" type="text" />
            </div>
            <div>
              <label for="piGold4Owner">Owner (His, Her, or Joint)</label>
              <input id="piGold4Owner" type="text" />
            </div>
            <div>
              <label for="piGold4StartAge">Start Age</label>
              <input id="piGold4StartAge" type="number" inputmode="decimal" />
            </div>
            <div>
              <label for="piGold4Annual">Annual Lifetime Income</label>
              <input id="piGold4Annual" type="number" inputmode="decimal" />
            </div>
            <div>
              <label for="piGold4Rollover">Rollover from Investments</label>
              <input id="piGold4Rollover" type="number" inputmode="decimal" />
            </div>
          </div>
        </div>

        <div class="ap-form-actions">
          <button type="button" id="save-plan-inputs" class="ap-primary-btn">
            Save Plan Inputs
          </button>
          <span id="planInputsStatus" class="ap-save-status"></span>
        </div>
      </section>

      <!-- STEP 4: PLAN COMPARISONS -->
      <section id="step-plans" class="ap-card ap-card-hidden">
        <h1>Plan Comparisons</h1>
        <p class="ap-intro">
          Compare <strong>No Plan</strong>, <strong>Silver Plan</strong>, and
          <strong>Gold Plan</strong>. Assets are color-coded:
          <strong style="color:#b91c1c;">Red</strong> = Investment Accounts (C),
          <strong style="color:#facc15;">Yellow</strong> = Savings/Checking/CU (A),
          <strong style="color:#166534;">Green</strong> = Annuities (B).
        </p>

        <div class="ap-form-section">
          <h2>Asset Allocation Snapshot (Base)</h2>
          <div class="asset-legend">
            <span class="asset-chip asset-chip-investments">Investments (C)</span>
            <span class="asset-chip asset-chip-savings">Savings / Checking / CU (A)</span>
            <span class="asset-chip asset-chip-annuities">Annuities (B)</span>
          </div>
          <table class="ap-table">
            <thead>
              <tr>
                <th>Category</th>
                <th>Amount</th>
                <th>% of Total</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Investment Accounts (C)</td>
                <td>
                  <span id="plan-alloc-investments" class="asset-chip asset-chip-investments">$0</span>
                </td>
                <td><span id="plan-alloc-investments-pct">0%</span></td>
              </tr>
              <tr>
                <td>Savings / Checking / Credit Union (A)</td>
                <td>
                  <span id="plan-alloc-savings" class="asset-chip asset-chip-savings">$0</span>
                </td>
                <td><span id="plan-alloc-savings-pct">0%</span></td>
              </tr>
              <tr>
                <td>Annuities (B)</td>
                <td>
                  <span id="plan-alloc-annuities" class="asset-chip asset-chip-annuities">$0</span>
                </td>
                <td><span id="plan-alloc-annuities-pct">0%</span></td>
              </tr>
              <tr>
                <th>Total Financial Assets</th>
                <th><span id="plan-alloc-total">$0</span></th>
                <th></th>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="ap-form-section">
          <h2>Plan Comparison – Income vs Expenses</h2>

          <div class="plan-tabs">
            <button class="plan-tab plan-tab-active" data-plan="no-plan">No Plan</button>
            <button class="plan-tab" data-plan="silver">Silver Plan</button>
            <button class="plan-tab" data-plan="gold">Gold Plan</button>
          </div>

          <!-- No Plan Card -->
          <div id="plan-no-plan" class="plan-card plan-card-no-plan">
            <div class="plan-card-header">No Plan – Current Path</div>
            <div class="plan-card-body">
              <div class="plan-metric-grid">
                <div class="plan-metric">
                  <div class="plan-metric-label">Annual Income (starting year)</div>
                  <div class="plan-metric-value" id="no-plan-income">$0</div>
                </div>
                <div class="plan-metric">
                  <div class="plan-metric-label">Annual Living Expenses</div>
                  <div class="plan-metric-value" id="no-plan-expenses">$0</div>
                </div>
                <div class="plan-metric">
                  <div class="plan-metric-label">Income Surplus / Shortfall</div>
                  <div class="plan-metric-value" id="no-plan-gap">$0</div>
                </div>
              </div>
              <p class="plan-note">
                No Plan uses only Social Security, pensions, and other income you entered on the Inputs page –
                with no additional guaranteed income from Silver or Gold rollovers.
              </p>

              <h3>Year-by-Year Schedule (Landscape)</h3>
              <div class="plan-schedule-wrapper">
                <table class="ap-table plan-schedule">
                  <thead>
                    <tr>
                      <th>Yr</th>
                      <th>His Age</th>
                      <th>Her Age</th>
                      <th class="col-his-ss">His Social Security</th>
                      <th class="col-her-ss">Her Social Security</th>
                      <th>Pension 1</th>
                      <th>Pension 2</th>
                      <th>Other Income</th>
                      <th>Total Income</th>
                      <th>Expenses</th>
                      <th>Surplus / Shortfall</th>
                    </tr>
                  </thead>
                  <tbody id="no-plan-schedule-body"></tbody>
                </table>
              </div>

              <h3 class="plan-summary-heading">Asset Allocation &amp; Income Summary – No Plan</h3>
              <div class="plan-summary-layout">
                <div class="plan-income-summary">
                  <div class="summary-abc-row">
                    <div class="summary-abc-item">
                      <span class="summary-abc-label summary-a">A</span>
                      <span class="summary-abc-value" id="np-A">$0</span>
                    </div>
                    <div class="summary-abc-item">
                      <span class="summary-abc-label summary-b">B</span>
                      <span class="summary-abc-value" id="np-B">$0</span>
                    </div>
                    <div class="summary-abc-item">
                      <span class="summary-abc-label summary-c">C</span>
                      <span class="summary-abc-value" id="np-C">$0</span>
                    </div>
                  </div>

                  <div class="plan-income-row">
                    <span class="label">Living Expenses Today</span>
                    <span id="np-living-today">$0</span>
                  </div>
                  <div class="plan-income-row main">
                    <span class="label">No Plan Retirement Income</span>
                    <span id="np-ret-income">$0</span>
                  </div>
                  <div class="plan-income-row">
                    <span class="label her">Her Survivor Income</span>
                    <span id="np-her-survivor">$0</span>
                  </div>
                  <div class="plan-income-row">
                    <span class="label his">His Survivor Income</span>
                    <span id="np-his-survivor">$0</span>
                  </div>
                </div>

                <div class="plan-pie-wrapper">
                  <canvas id="np-asset-pie" class="plan-pie-canvas"></canvas>
                </div>
              </div>
            </div>
          </div>

          <!-- Silver Plan Card -->
          <div id="plan-silver" class="plan-card plan-card-silver plan-card-hidden">
            <div class="plan-card-header">Silver Plan – Additional Guaranteed Income</div>
            <div class="plan-card-body">
              <div class="plan-metric-grid">
                <div class="plan-metric">
                  <div class="plan-metric-label">Annual Income (starting year)</div>
                  <div class="plan-metric-value" id="silver-plan-income">$0</div>
                </div>
                <div class="plan-metric">
                  <div class="plan-metric-label">Annual Living Expenses</div>
                  <div class="plan-metric-value" id="silver-plan-expenses">$0</div>
                </div>
                <div class="plan-metric">
                  <div class="plan-metric-label">Income Surplus / Shortfall</div>
                  <div class="plan-metric-value" id="silver-plan-gap">$0</div>
                </div>
              </div>
              <p class="plan-note">
                Silver Plan adds income from the Silver rollover sources you entered on the Inputs page,
                on top of the No Plan income.
              </p>

              <h3>Year-by-Year Schedule (Landscape)</h3>
              <div class="plan-schedule-wrapper">
                <table class="ap-table plan-schedule">
                  <thead>
                    <tr>
                      <th>Yr</th>
                      <th>His Age</th>
                      <th>Her Age</th>
                      <th class="col-his-ss">His Social Security</th>
                      <th class="col-her-ss">Her Social Security</th>
                      <th>Pension 1</th>
                      <th>Pension 2</th>
                      <th>Other Income</th>
                      <th id="th-silver1">Silver 1 Income</th>
                      <th id="th-silver2">Silver 2 Income</th>
                      <th id="th-silver3">Silver 3 Income</th>
                      <th id="th-silver4">Silver 4 Income</th>
                      <th>Total Income</th>
                      <th>Expenses</th>
                      <th>Surplus / Shortfall</th>
                    </tr>
                  </thead>
                  <tbody id="silver-schedule-body"></tbody>
                </table>
              </div>

              <h3 class="plan-summary-heading">Asset Allocation &amp; Income Summary – Silver Plan</h3>
              <div class="plan-summary-layout">
                <div class="plan-income-summary">
                  <div class="summary-abc-row">
                    <div class="summary-abc-item">
                      <span class="summary-abc-label summary-a">A</span>
                      <span class="summary-abc-value" id="sp-A">$0</span>
                    </div>
                    <div class="summary-abc-item">
                      <span class="summary-abc-label summary-b">B</span>
                      <span class="summary-abc-value" id="sp-B">$0</span>
                    </div>
                    <div class="summary-abc-item">
                      <span class="summary-abc-label summary-c">C</span>
                      <span class="summary-abc-value" id="sp-C">$0</span>
                    </div>
                  </div>

                  <div class="plan-income-row">
                    <span class="label">Living Expenses Today</span>
                    <span id="sp-living-today">$0</span>
                  </div>
                  <div class="plan-income-row main">
                    <span class="label">Silver Plan Retirement Income</span>
                    <span id="sp-ret-income">$0</span>
                  </div>
                  <div class="plan-income-row">
                    <span class="label her">Her Survivor Income</span>
                    <span id="sp-her-survivor">$0</span>
                  </div>
                  <div class="plan-income-row">
                    <span class="label his">His Survivor Income</span>
                    <span id="sp-his-survivor">$0</span>
                  </div>
                </div>

                <div class="plan-pie-wrapper">
                  <canvas id="sp-asset-pie" class="plan-pie-canvas"></canvas>
                </div>
              </div>
            </div>
          </div>

          <!-- Gold Plan Card -->
          <div id="plan-gold" class="plan-card plan-card-gold plan-card-hidden">
            <div class="plan-card-header">Gold Plan – Maximum Income Strategy</div>
            <div class="plan-card-body">
              <div class="plan-metric-grid">
                <div class="plan-metric">
                  <div class="plan-metric-label">Annual Income (starting year)</div>
                  <div class="plan-metric-value" id="gold-plan-income">$0</div>
                </div>
                <div class="plan-metric">
                  <div class="plan-metric-label">Annual Living Expenses</div>
                  <div class="plan-metric-value" id="gold-plan-expenses">$0</div>
                </div>
                <div class="plan-metric">
                  <div class="plan-metric-label">Income Surplus / Shortfall</div>
                  <div class="plan-metric-value" id="gold-plan-gap">$0</div>
                </div>
              </div>
              <p class="plan-note">
                Gold Plan adds income from the Gold rollover sources you entered on the Inputs page,
                on top of the No Plan income.
              </p>

              <h3>Year-by-Year Schedule (Landscape)</h3>
              <div class="plan-schedule-wrapper">
                <table class="ap-table plan-schedule">
                  <thead>
                    <tr>
                      <th>Yr</th>
                      <th>His Age</th>
                      <th>Her Age</th>
                      <th class="col-his-ss">His Social Security</th>
                      <th class="col-her-ss">Her Social Security</th>
                      <th>Pension 1</th>
                      <th>Pension 2</th>
                      <th>Other Income</th>
                      <th id="th-gold1">Gold 1 Income</th>
                      <th id="th-gold2">Gold 2 Income</th>
                      <th id="th-gold3">Gold 3 Income</th>
                      <th id="th-gold4">Gold 4 Income</th>
                      <th>Total Income</th>
                      <th>Expenses</th>
                      <th>Surplus / Shortfall</th>
                    </tr>
                  </thead>
                  <tbody id="gold-schedule-body"></tbody>
                </table>
              </div>

              <h3 class="plan-summary-heading">Asset Allocation &amp; Income Summary – Gold Plan</h3>
              <div class="plan-summary-layout">
                <div class="plan-income-summary">
                  <div class="summary-abc-row">
                    <div class="summary-abc-item">
                      <span class="summary-abc-label summary-a">A</span>
                      <span class="summary-abc-value" id="gp-A">$0</span>
                    </div>
                    <div class="summary-abc-item">
                      <span class="summary-abc-label summary-b">B</span>
                      <span class="summary-abc-value" id="gp-B">$0</span>
                    </div>
                    <div class="summary-abc-item">
                      <span class="summary-abc-label summary-c">C</span>
                      <span class="summary-abc-value" id="gp-C">$0</span>
                    </div>
                  </div>

                  <div class="plan-income-row">
                    <span class="label">Living Expenses Today</span>
                    <span id="gp-living-today">$0</span>
                  </div>
                  <div class="plan-income-row main">
                    <span class="label">Gold Plan Retirement Income</span>
                    <span id="gp-ret-income">$0</span>
                  </div>
                  <div class="plan-income-row">
                    <span class="label her">Her Survivor Income</span>
                    <span id="gp-her-survivor">$0</span>
                  </div>
                  <div class="plan-income-row">
                    <span class="label his">His Survivor Income</span>
                    <span id="gp-his-survivor">$0</span>
                  </div>
                </div>

                <div class="plan-pie-wrapper">
                  <canvas id="gp-asset-pie" class="plan-pie-canvas"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- STEP 5: SUMMARY & REPORT -->
      <section id="step-summary" class="ap-card ap-card-hidden">
        <h1>Summary &amp; Next Steps</h1>
        <p class="ap-intro">
          Use the <strong>No Plan, Silver, and Gold</strong> comparisons to help your clients
          see the value of guaranteed lifetime income and survivor protection. You can
          print the schedules from your browser or screen-share during a meeting.
        </p>
        <ul class="ap-bullets">
          <li>Review the survivor income lines for both spouses.</li>
          <li>Highlight the change in A/B/C asset allocation from No Plan to Silver and Gold.</li>
          <li>Discuss which combination of guarantees and flexibility best fits their goals.</li>
        </ul>
        <p>
          This web version mirrors your original Excel Income-for-Life Plan while making it easier
          to use on a laptop or tablet with clients.
        </p>
      </section>
    </main>

    <footer class="ap-footer">
      <div>America United Wealth Planning &bull; AmericaPlanning.com</div>
      <div>For illustration purposes only. Not a contract or guarantee.</div>
    </footer>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Inlined app logic (desktop, same as your updated app.js) -->
  <script>
    (function () {
      const STORAGE_KEYS = {
        CLIENT: "ap_ifl_client_data",
        INPUTS: "ap_ifl_plan_inputs",
      };

      const state = {
        client: null,
        inputs: null,
        charts: {
          np: null,
          sp: null,
          gp: null,
        },
      };

      function $(selector) {
        return document.querySelector(selector);
      }

      function $all(selector) {
        return Array.from(document.querySelectorAll(selector));
      }

      function toNumber(val) {
        const n = parseFloat(String(val).replace(/,/g, ""));
        return isNaN(n) ? 0 : n;
      }

      function fmtCurrency(val) {
        const n = toNumber(val);
        return n.toLocaleString("en-US", {
          style: "currency",
          currency: "USD",
          maximumFractionDigits: 0,
        });
      }

      function fmtPercent(val) {
        const n = toNumber(val);
        return n.toFixed(1) + "%";
      }

      function showStatus(el, message) {
        if (!el) return;
        el.textContent = message;
        el.classList.add("ap-save-status-visible");
        setTimeout(() => {
          el.classList.remove("ap-save-status-visible");
        }, 2500);
      }

      function saveToStorage(key, data) {
        try {
          localStorage.setItem(key, JSON.stringify(data));
        } catch (e) {
          console.error("LocalStorage save error", e);
        }
      }

      function loadFromStorage(key) {
        try {
          const raw = localStorage.getItem(key);
          return raw ? JSON.parse(raw) : null;
        } catch (e) {
          console.error("LocalStorage load error", e);
          return null;
        }
      }

      function initStepNavigation() {
        const stepButtons = $all(".ap-step-btn");
        const cards = $all(".ap-card");

        function activateStep(stepName) {
          stepButtons.forEach((btn) => {
            if (btn.dataset.step === stepName) {
              btn.classList.add("ap-step-btn-active");
            } else {
              btn.classList.remove("ap-step-btn-active");
            }
          });

          cards.forEach((card) => {
            if (card.id === "step-" + stepName) {
              card.classList.remove("ap-card-hidden");
            } else {
              card.classList.add("ap-card-hidden");
            }
          });
        }

        stepButtons.forEach((btn) => {
          btn.addEventListener("click", () => {
            const stepName = btn.dataset.step;
            if (stepName) activateStep(stepName);
          });
        });

        activateStep("client");
      }

      function readClientForm() {
        const ids = [
          "clientName",
          "spouseName",
          "advisorName",
          "planDate",
          "primaryValue",
          "primaryMortgage",
          "secondaryValue",
          "secondaryMortgage",
          "inv1Balance",
          "inv2Balance",
          "inv3Balance",
          "inv4Balance",
          "inv5Balance",
          "sav1Balance",
          "sav2Balance",
          "sav3Balance",
          "sav4Balance",
          "sav5Balance",
          "ann1Balance",
          "ann2Balance",
          "ann3Balance",
          "ann4Balance",
          "ann5Balance",
        ];

        const data = {};
        ids.forEach((id) => {
          const el = $("#" + id);
          if (!el) return;
          if (el.type === "number") {
            data[id] = toNumber(el.value);
          } else {
            data[id] = el.value || "";
          }
        });
        return data;
      }

      function fillClientForm(data) {
        if (!data) return;
        Object.keys(data).forEach((id) => {
          const el = $("#" + id);
          if (!el) return;
          if (el.type === "number") {
            el.value = data[id] || data[id] === 0 ? data[id] : "";
          } else {
            el.value = data[id] || "";
          }
        });
      }

      function computeAssetSummary(client) {
        if (!client) {
          return {
            primaryValue: 0,
            primaryMortgage: 0,
            secondaryValue: 0,
            secondaryMortgage: 0,
            primaryEquity: 0,
            secondaryEquity: 0,
            totalRealEstateEquity: 0,
            investments: { total: 0, count: 0 },
            savings: { total: 0, count: 0 },
            annuities: { total: 0, count: 0 },
            totalFinancial: 0,
            totalAssets: 0,
          };
        }

        const primaryValue = toNumber(client.primaryValue);
        const primaryMortgage = toNumber(client.primaryMortgage);
        const secondaryValue = toNumber(client.secondaryValue);
        const secondaryMortgage = toNumber(client.secondaryMortgage);

        const primaryEquity = Math.max(0, primaryValue - primaryMortgage);
        const secondaryEquity = Math.max(0, secondaryValue - secondaryMortgage);
        const totalRealEstateEquity = primaryEquity + secondaryEquity;

        const invIds = ["inv1Balance", "inv2Balance", "inv3Balance", "inv4Balance", "inv5Balance"];
        const savIds = ["sav1Balance", "sav2Balance", "sav3Balance", "sav4Balance", "sav5Balance"];
        const annIds = ["ann1Balance", "ann2Balance", "ann3Balance", "ann4Balance", "ann5Balance"];

        function sumCategory(ids) {
          let total = 0;
          let count = 0;
          ids.forEach((id) => {
            const val = toNumber(client[id]);
            if (val > 0) {
              total += val;
              count += 1;
            }
          });
          return { total, count };
        }

        const investments = sumCategory(invIds);
        const savings = sumCategory(savIds);
        const annuities = sumCategory(annIds);

        const totalFinancial = investments.total + savings.total + annuities.total;
        const totalAssets = totalRealEstateEquity + totalFinancial;

        return {
          primaryValue,
          primaryMortgage,
          secondaryValue,
          secondaryMortgage,
          primaryEquity,
          secondaryEquity,
          totalRealEstateEquity,
          investments,
          savings,
          annuities,
          totalFinancial,
          totalAssets,
        };
      }

      function updateAssetSummaryUI(summary) {
        if (!summary) return;

        $("#as-primary-value").textContent = fmtCurrency(summary.primaryValue);
        $("#as-primary-mortgage").textContent = fmtCurrency(summary.primaryMortgage);
        $("#as-primary-equity").textContent = fmtCurrency(summary.primaryEquity);

        $("#as-secondary-value").textContent = fmtCurrency(summary.secondaryValue);
        $("#as-secondary-mortgage").textContent = fmtCurrency(summary.secondaryMortgage);
        $("#as-secondary-equity").textContent = fmtCurrency(summary.secondaryEquity);

        $("#as-total-real-estate-equity").textContent = fmtCurrency(summary.totalRealEstateEquity);

        $("#as-portfolio-count").textContent = summary.investments.count;
        $("#as-portfolio-total").textContent = fmtCurrency(summary.investments.total);

        $("#as-savings-count").textContent = summary.savings.count;
        $("#as-savings-total").textContent = fmtCurrency(summary.savings.total);

        $("#as-annuities-count").textContent = summary.annuities.count;
        $("#as-annuities-total").textContent = fmtCurrency(summary.annuities.total);

        $("#as-total-financial-assets").textContent = fmtCurrency(summary.totalFinancial);
        $("#as-total-assets").textContent = fmtCurrency(summary.totalAssets);

        $("#plan-alloc-investments").textContent = fmtCurrency(summary.investments.total);
        $("#plan-alloc-savings").textContent = fmtCurrency(summary.savings.total);
        $("#plan-alloc-annuities").textContent = fmtCurrency(summary.annuities.total);
        $("#plan-alloc-total").textContent = fmtCurrency(summary.totalFinancial);

        const total = summary.totalFinancial || 1;
        const invPct = (summary.investments.total / total) * 100;
        const savPct = (summary.savings.total / total) * 100;
        const annPct = (summary.annuities.total / total) * 100;

        $("#plan-alloc-investments-pct").textContent = fmtPercent(invPct);
        $("#plan-alloc-savings-pct").textContent = fmtPercent(savPct);
        $("#plan-alloc-annuities-pct").textContent = fmtPercent(annPct);

        updateCharts(summary);
      }

      function readPlanInputs() {
        const ids = [
          "piHisCurrentAge",
          "piHerCurrentAge",
          "piProjectionYears",
          "piHisDeathAge",
          "piHerDeathAge",
          "piHisSSAnnual",
          "piHerSSAnnual",
          "piSSGrowthPct",
          "piHisSSStartAge",
          "piHerSSStartAge",
          "piPension1Annual",
          "piPension1StartAge",
          "piPension1SurvivorPct",
          "piPension2Annual",
          "piPension2StartAge",
          "piPension2SurvivorPct",
          "piPensionGrowthPct",
          "piOtherIncomeAnnual",
          "piLivingExpensesAnnual",
          "piExpenseInflationPct",
          "piSilver1Desc", "piSilver1Owner", "piSilver1StartAge", "piSilver1Annual", "piSilver1Rollover",
          "piSilver2Desc", "piSilver2Owner", "piSilver2StartAge", "piSilver2Annual", "piSilver2Rollover",
          "piSilver3Desc", "piSilver3Owner", "piSilver3StartAge", "piSilver3Annual", "piSilver3Rollover",
          "piSilver4Desc", "piSilver4Owner", "piSilver4StartAge", "piSilver4Annual", "piSilver4Rollover",
          "piGold1Desc", "piGold1Owner", "piGold1StartAge", "piGold1Annual", "piGold1Rollover",
          "piGold2Desc", "piGold2Owner", "piGold2StartAge", "piGold2Annual", "piGold2Rollover",
          "piGold3Desc", "piGold3Owner", "piGold3StartAge", "piGold3Annual", "piGold3Rollover",
          "piGold4Desc", "piGold4Owner", "piGold4StartAge", "piGold4Annual", "piGold4Rollover",
        ];

        const inputs = {};
        ids.forEach((id) => {
          const el = $("#" + id);
          if (!el) return;
          if (el.type === "number") {
            inputs[id] = toNumber(el.value);
          } else {
            inputs[id] = el.value || "";
          }
        });
        return inputs;
      }

      function fillPlanInputs(inputs) {
        if (!inputs) return;
        Object.keys(inputs).forEach((id) => {
          const el = $("#" + id);
          if (!el) return;
          if (el.type === "number") {
            el.value = inputs[id] || inputs[id] === 0 ? inputs[id] : "";
          } else {
            el.value = inputs[id] || "";
          }
        });

        if (inputs.piSilver1Desc) $("#th-silver1").textContent = inputs.piSilver1Desc;
        if (inputs.piSilver2Desc) $("#th-silver2").textContent = inputs.piSilver2Desc;
        if (inputs.piSilver3Desc) $("#th-silver3").textContent = inputs.piSilver3Desc;
        if (inputs.piSilver4Desc) $("#th-silver4").textContent = inputs.piSilver4Desc;

        if (inputs.piGold1Desc) $("#th-gold1").textContent = inputs.piGold1Desc;
        if (inputs.piGold2Desc) $("#th-gold2").textContent = inputs.piGold2Desc;
        if (inputs.piGold3Desc) $("#th-gold3").textContent = inputs.piGold3Desc;
        if (inputs.piGold4Desc) $("#th-gold4").textContent = inputs.piGold4Desc;
      }

      function computeBaseIncome(inputs) {
        if (!inputs) return { baseIncome: 0, expenses: 0 };
        const hisSS = inputs.piHisSSAnnual || 0;
        const herSS = inputs.piHerSSAnnual || 0;
        const p1 = inputs.piPension1Annual || 0;
        const p2 = inputs.piPension2Annual || 0;
        const other = inputs.piOtherIncomeAnnual || 0;
        const expenses = inputs.piLivingExpensesAnnual || 0;
        const baseIncome = hisSS + herSS + p1 + p2 + other;
        return { baseIncome, expenses };
      }

      function computeSilverGoldAddl(inputs, prefix) {
        const annualIds = [
          "pi" + prefix + "1Annual",
          "pi" + prefix + "2Annual",
          "pi" + prefix + "3Annual",
          "pi" + prefix + "4Annual",
        ];
        let total = 0;
        annualIds.forEach((id) => {
          total += inputs[id] || 0;
        });
        return total;
      }

      function updatePlanSummaryUI() {
        const inputs = state.inputs || {};
        const { baseIncome, expenses } = computeBaseIncome(inputs);

        const silverAddl = computeSilverGoldAddl(inputs, "Silver");
        const goldAddl = computeSilverGoldAddl(inputs, "Gold");

        const npIncome = baseIncome;
        const npGap = npIncome - expenses;

        $("#no-plan-income").textContent = fmtCurrency(npIncome);
        $("#no-plan-expenses").textContent = fmtCurrency(expenses);
        $("#no-plan-gap").textContent = fmtCurrency(npGap);

        const spIncome = baseIncome + silverAddl;
        const spGap = spIncome - expenses;

        $("#silver-plan-income").textContent = fmtCurrency(spIncome);
        $("#silver-plan-expenses").textContent = fmtCurrency(expenses);
        $("#silver-plan-gap").textContent = fmtCurrency(spGap);

        const gpIncome = baseIncome + goldAddl;
        const gpGap = gpIncome - expenses;

        $("#gold-plan-income").textContent = fmtCurrency(gpIncome);
        $("#gold-plan-expenses").textContent = fmtCurrency(expenses);
        $("#gold-plan-gap").textContent = fmtCurrency(gpGap);

        const hisSS = inputs.piHisSSAnnual || 0;
        const herSS = inputs.piHerSSAnnual || 0;
        const p1 = inputs.piPension1Annual || 0;
        const p2 = inputs.piPension2Annual || 0;
        const p1SurvPct = (inputs.piPension1SurvivorPct || 100) / 100;
        const p2SurvPct = (inputs.piPension2SurvivorPct || 100) / 100;
        const other = inputs.piOtherIncomeAnnual || 0;

        const survivorBase = Math.max(hisSS, herSS) + p1 * p1SurvPct + p2 * p2SurvPct + other;

        $("#np-living-today").textContent = fmtCurrency(expenses);
        $("#np-ret-income").textContent = fmtCurrency(npIncome);
        $("#np-her-survivor").textContent = fmtCurrency(survivorBase);
        $("#np-his-survivor").textContent = fmtCurrency(survivorBase);

        const spSurvivor = survivorBase + silverAddl;
        $("#sp-living-today").textContent = fmtCurrency(expenses);
        $("#sp-ret-income").textContent = fmtCurrency(spIncome);
        $("#sp-her-survivor").textContent = fmtCurrency(spSurvivor);
        $("#sp-his-survivor").textContent = fmtCurrency(spSurvivor);

        const gpSurvivor = survivorBase + goldAddl;
        $("#gp-living-today").textContent = fmtCurrency(expenses);
        $("#gp-ret-income").textContent = fmtCurrency(gpIncome);
        $("#gp-her-survivor").textContent = fmtCurrency(gpSurvivor);
        $("#gp-his-survivor").textContent = fmtCurrency(gpSurvivor);

        const summary = computeAssetSummary(state.client);
        if (!summary) return;

        $("#np-A").textContent = fmtCurrency(summary.savings.total);
        $("#np-B").textContent = fmtCurrency(summary.annuities.total);
        $("#np-C").textContent = fmtCurrency(summary.investments.total);

        $("#sp-A").textContent = fmtCurrency(summary.savings.total);
        $("#sp-B").textContent = fmtCurrency(summary.annuities.total);
        $("#sp-C").textContent = fmtCurrency(summary.investments.total);

        $("#gp-A").textContent = fmtCurrency(summary.savings.total);
        $("#gp-B").textContent = fmtCurrency(summary.annuities.total);
        $("#gp-C").textContent = fmtCurrency(summary.investments.total);
      }

      function createPieChart(ctx, data) {
        if (!window.Chart || !ctx) return null;
        return new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: ["Savings (A)", "Annuities (B)", "Investments (C)"],
            datasets: [
              {
                data: [data.savings, data.annuities, data.investments],
                backgroundColor: ["#facc15", "#16a34a", "#b91c1c"],
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "bottom",
              },
            },
          },
        });
      }

      function updateCharts(summary) {
        if (!window.Chart || !summary) return;

        const data = {
          savings: summary.savings.total,
          annuities: summary.annuities.total,
          investments: summary.investments.total,
        };

        const npCtx = document.getElementById("np-asset-pie")?.getContext("2d");
        const spCtx = document.getElementById("sp-asset-pie")?.getContext("2d");
        const gpCtx = document.getElementById("gp-asset-pie")?.getContext("2d");

        ["np", "sp", "gp"].forEach((key) => {
          if (state.charts[key]) {
            state.charts[key].destroy();
            state.charts[key] = null;
          }
        });

        state.charts.np = createPieChart(npCtx, data);
        state.charts.sp = createPieChart(spCtx, data);
        state.charts.gp = createPieChart(gpCtx, data);
      }

      function initPlanTabs() {
        const tabs = $all(".plan-tab");
        const cards = {
          "no-plan": document.getElementById("plan-no-plan"),
          silver: document.getElementById("plan-silver"),
          gold: document.getElementById("plan-gold"),
        };

        function activate(plan) {
          tabs.forEach((t) => {
            if (t.dataset.plan === plan) {
              t.classList.add("plan-tab-active");
            } else {
              t.classList.remove("plan-tab-active");
            }
          });

          Object.keys(cards).forEach((key) => {
            const card = cards[key];
            if (!card) return;
            if (key === plan) {
              card.classList.remove("plan-card-hidden");
            } else {
              card.classList.add("plan-card-hidden");
            }
          });
        }

        tabs.forEach((t) => {
          t.addEventListener("click", () => {
            const plan = t.dataset.plan;
            if (plan) activate(plan);
          });
        });

        activate("no-plan");
      }

      document.addEventListener("DOMContentLoaded", () => {
        initStepNavigation();
        initPlanTabs();

        const storedClient = loadFromStorage(STORAGE_KEYS.CLIENT);
        const storedInputs = loadFromStorage(STORAGE_KEYS.INPUTS);

        if (storedClient) {
          state.client = storedClient;
          fillClientForm(storedClient);
        }
        if (storedInputs) {
          state.inputs = storedInputs;
          fillPlanInputs(storedInputs);
        }

        const summary = computeAssetSummary(state.client);
        updateAssetSummaryUI(summary);
        updatePlanSummaryUI();

        const clientForm = document.getElementById("client-form");
        const saveStatus = document.getElementById("saveStatus");
        if (clientForm) {
          clientForm.addEventListener("submit", (e) => {
            e.preventDefault();
            const data = readClientForm();
            state.client = data;
            saveToStorage(STORAGE_KEYS.CLIENT, data);

            const summary = computeAssetSummary(data);
            updateAssetSummaryUI(summary);
            updatePlanSummaryUI();

            showStatus(saveStatus, "Client data saved.");
          });
        }

        const saveInputsBtn = document.getElementById("save-plan-inputs");
        const planInputsStatus = document.getElementById("planInputsStatus");
        if (saveInputsBtn) {
          saveInputsBtn.addEventListener("click", () => {
            const inputs = readPlanInputs();
            state.inputs = inputs;
            saveToStorage(STORAGE_KEYS.INPUTS, inputs);

            fillPlanInputs(inputs);
            updatePlanSummaryUI();

            showStatus(planInputsStatus, "Plan inputs saved.");
          });
        }
      });
    })();
  </script>
</div>
